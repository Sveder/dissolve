<html>
  <head>
    <link rel="shortcut icon" href="http://sveder.com/freshpaint/favicon.ico">
    <script type="text/javascript" src="jscolor/jscolor.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
    <script type="text/javascript" src="data.js"></script>    

    <style>
      
      .mirror {
        -moz-transform: scale(-1, 1);
        -webkit-transform: scale(-1, 1);
        -o-transform: scale(-1, 1);
        transform: scale(-1, 1);
        filter: FlipH;
      }
      #demo-frame > div.demo { padding: 10px !important; }
      
    </style>
  </head>
  
  <body style="background-color:lightgray;" onload="initialize();">
    <canvas style="z-index:-1;margin:0;padding:0;border-width: 0; height: 85%; width: 100%;" id="canvas-final"></canvas>
    
    
    <video style="display:none;" id="video-canvas-fancy" controls muted autoplay>
      <source src="video/tour1.m4v" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"' />
    </video>
    
    <video style="display:none;" id="video-second" controls muted autoplay>
      <source src="" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"' />
    </video>
    
    <canvas style= "display:none;" id="canvas-copy-fancy"></canvas>
    <span style="font:bold 20px sans-serif">Video Effects</span>
    <span style="float:right; font:bold 20px sans-serif">Audio Effects</span> </br></br>
    
    Opacity:
    
    <div id="slider"></div>

    <button type="button" onclick="toggle_bw();">Black and white</button>
    <button type="button" onclick="toggle_invert();">Invert</button>
    <button type="button" onclick="toggle_mirror();">Mirror</button>
    <button type="button" onclick="shake();">Shake</button>
    <button type="button" onclick="tester();">Frame?</button>
    
    </br>
    <button type="button" onclick="document.getElementById('color_picker').color.showPicker();">Color Filter</button>
    <input id="color_picker" class="color {pickerClosable:true} {pickerOnfocus:false}" onchange="color_picked(this.color);" mouseout="this.hidePicker();">

    <div id="audio-div"></div>


    <script>
      var video_dom = document.querySelector('#video-canvas-fancy');
      var video_second = document.querySelector('#video-second');
      
      var canvas_copy = document.querySelector('#canvas-copy-fancy');
      var canvas_final = document.querySelector('#canvas-final');
      
      var interval = null;
      var ctx_copy = null;
      var ctx_second = null;
      
      var should_bw = false;
      var should_invert = false;
      var should_mirror = false;
      
      var change_red = 1;
      var change_green = 1;
      var change_blue = 1;
      
      var frame = 0;
      var desc = "";
      
      var frame_effect = new Object();

      
      function color_picked(color){
        toggle_red(color.rgb[0]);
        toggle_green(color.rgb[1]);
        toggle_blue(color.rgb[2]);
      }
      
      
      function getParameterByName(name)
      {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.search);
        if(results == null)
          return "";
        else
          return decodeURIComponent(results[1].replace(/\+/g, " "));
      }
      
      function prep_replay(link_text){
        console.log("moo");
        var url = "reader.php?link_text=" + link_text;
        var data = encodeURIComponent(link_text);
        var http = new XMLHttpRequest();
        http.open("GET", url, true);
        
        //Send the proper header information along with the request
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        
        http.onreadystatechange = function() {//Call a function when the state changes.
                if(http.readyState == 4 && http.status == 200) {
                        start_replay(http.responseText);
                }
        }
        http.send();
      }
      
      function start_replay(recreate){
        console.log(recreate);
        var parts = recreate.split(";");
        var i = 0;
        while (i < parts.length){
          var command = parts[i].split("=");
          if (command[0] == "video_first"){
            var loc = parseInt(command[1]);
            var tour = MARKER_LOC_LIST[loc];
            console.log("videp = " + loc);
            desc += "video_first=" + loc + ";";
            document.querySelector('#video-canvas-fancy').setAttribute('src', tour.video);
            add_audio_control(tour.sound);

          } else if (command[0] == "video_second"){
            var loc = parseInt(command[1]);
            var tour = MARKER_LOC_LIST[loc];
            console.log("videp = " + loc);
            desc += "video_second=" + loc + ";";
            document.querySelector('#video-second').setAttribute('src', tour.video);
            add_audio_control(tour.sound);
            
          } else if (command[0] == "frame"){
            var frame_num = parseInt(command[1]);
            i += 1;
            frame_effect[frame_num] = parts[i];
          }
          i += 1;
        }
      }
      
      function initialize(){
        var should_replay = getParameterByName("replay");
        if (should_replay != ""){
          prep_replay(should_replay);
        }
        
        else {
        
          var chosen_markers = getParameterByName("markers");
          var chosen_count = 0;
          for (var i=0; i < chosen_markers.length; i++){
            var is_selected = chosen_markers[i] == "V";
            if (is_selected){
              var tour = MARKER_LOC_LIST[i];
              if (chosen_count == 0){
                 desc += "video_first=" + i + ";";
                 document.querySelector('#video-canvas-fancy').setAttribute('src', tour.video);
                 add_audio_control(tour.sound);
              }
              
              if (chosen_count == 1){
                desc += "video_second=" + i + ";";
                document.querySelector('#video-second').setAttribute('src', tour.video);
                add_audio_control(tour.sound);
  
                break;
              }
              
              chosen_count += 1;
            }
          }
        }
        add_audio_control("audio/ambient.mp3");
        add_audio_control("audio/beats.mp3");
        
        video_dom.addEventListener('canplay', function() {
        canvas_copy.width = video_dom.videoWidth;
        canvas_copy.height = video_dom.videoHeight;
        
        ctx_copy = canvas_copy.getContext('2d');
        
        canvas_final.width = video_dom.videoWidth;
        canvas_final.height = video_dom.videoHeight;
        ctx_final = canvas_final.getContext('2d');
        
      }, false);
      
      
      video_dom.addEventListener('play', function() {
        processEffectFrame();
        if (interval == null) {
          interval = window.setInterval(function() { processEffectFrame() }, 33);
        }        
      }, false);
      }
      
      function processEffectFrame() {
        frame += 1;
        if (frame_effect[frame] != null){
          var parts = frame_effect[frame].split("=");
          var effect = parts[0];
          var new_val = parseInt(parts[1]);
          
          switch(effect){
            case "opacity":
              change_opacity(new_val);              
              break;
            
            case "should_bw":
              toggle_bw();
              break;
            
            case "should_invert":
              toggle_invert();
              break;
            
            case "should_mirror":
              toggle_mirror();
              break;
            
            case "shake":
              shake();
              break;
            
            case "toggle_red":
              toggle_red(new_val);
              break;
            
            case "toggle_green":
              toggle_green(new_val);
              break;
            
            case "toggle_blue":
              toggle_blue(new_val);
              break;
          }
        }
        
        ctx_copy.drawImage(video_dom, 0, 0);
        
        first_start = video_dom.videoWidth / 3.0;
        second_start = video_second.videoWidth / 3.0;
        ctx_copy.drawImage(video_second, second_start, 0, second_start, video_second.videoHeight, first_start, 0, first_start, video_dom.videoHeight);
        
        var image_data = ctx_copy.getImageData(0, 0, canvas_copy.width, canvas_copy.height);

        var data = image_data.data
        
        if (should_bw){
          make_black_and_white(data, canvas_copy.width, canvas_copy.height);
        }
        
        if (should_invert){
          invert(data, canvas_copy.width, canvas_copy.height);
        }
        
        if ((change_red != 1) || (change_blue != 1) || (change_green != 1) && (!should_bw)){
          recolor(data, canvas_copy.width, canvas_copy.height);
        }
        
        mirror(should_mirror);
        
        ctx_final.putImageData(image_data, 0, 0);
      };
      
      video_dom.addEventListener('pause', function() {
        window.clearInterval(interval);
        interval = null;
      }, false);
      
      video_dom.addEventListener('ended', function() {
        clearInterval(interval);
        playback_ended();
      }, false);
      
      function change_opacity(new_val){
        desc += "frame=" + frame + ";opacity=" + new_val + ";";
        var canvas_copy = document.querySelector('#canvas-final');
        canvas_copy.style.opacity = new_val;
      }
      
      function per_pixel_effect(data, width, height, func){
        for (var y = 0; y < height; y += 1)
	{
          for (var x = 0; x < width; x += 1)
          {
            
            var pixel = (y * width + x)*4;
            var new_pixel = func(data[pixel], data[pixel + 1], data[pixel + 2], data[pixel + 3]);
            
            data[pixel] = new_pixel[0];
            data[pixel+1] = new_pixel[1];
            data[pixel+2] = new_pixel[2];
            data[pixel+3] = new_pixel[3];
            
          }	   
    	}
        
      }
      
      function toggle_red(new_val){
        change_red = new_val;
        desc += "frame=" + frame + ";change_red=" + change_red + ";";
      }
      
      function toggle_green(new_val){
        change_green = new_val;
        desc += "frame=" + frame + ";change_green=" + change_green + ";";
      }
      
      function toggle_blue(new_val){
        change_blue = new_val;
        desc += "frame=" + frame + ";change_blue=" + change_blue + ";";
      }
      
      function toggle_bw(){
        should_bw = !should_bw;
        desc += "frame=" + frame + ";should_bw=" + should_bw + ";";
      }
      
      function make_black_and_white(data, width, height){
        per_pixel_effect(data, width, height, function(r, g, b, a){
            var single = r*.21 + g*.71 + b*.07;
            return [single, single, single, a];          
          });
      }
      
      function toggle_invert(){
        should_invert = !should_invert;
        desc += "frame=" + frame + ";should_invert=" + should_invert + ";";
      }
      
      function invert(data, width, height){
        per_pixel_effect(data, width, height, function(r, g, b, a){
          return [255 - r, 255 - g, 255 - b, a];
        });
      }
      
      function recolor(data, width, height){
        per_pixel_effect(data, width, height, function(r, g, b, a){
          return [Math.round(r * change_red), Math.round(g * change_green), Math.round(b * change_blue), a];
        });
      }
      
      function toggle_mirror(){
        should_mirror = !should_mirror;
        desc += "frame=" + frame + ";should_mirror=" + should_mirror + ";";
      }
      
      function mirror(should_mirror){
        if (should_mirror){
          canvas_final.className = "mirror";
        }
        else {
          canvas_final.className = "";
        }
      }
      
      function shake(){
        desc += "frame=" + frame + ";shake=1;";
        $("#canvas-final").effect("shake", { times:3, distance:30}, "fast");
      }
      
      
      function show_link(link_text){
        alert(link_text);
      }
      
      function playback_ended(){
        post_data();
      }
      
      function post_data(){
        var url = "saver.php";
        var data = encodeURIComponent(desc);
        var params = "&data=" + data;
        var http = new XMLHttpRequest();
        http.open("POST", url, true);
        
        //Send the proper header information along with the request
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        
        http.onreadystatechange = function() {//Call a function when the state changes.
                if(http.readyState == 4 && http.status == 200) {
                        show_link(http.responseText);
                        
                }
        }
        http.send(params);
        
      }
      
      function tester(){
        post_data();
      }
      
      function add_audio_control(audio_name){
        var audio_element = document.createElement('span');
        audio_element.innerHTML = "<audio id='new_audio' autoplay controls='controls'><source src=" + audio_name + " type='audio/mp3'/>Your browser does not support the audio tag.</audio>";
        
        var audio_div = document.getElementById('audio-div');
        audio_div.appendChild(audio_element);
        $("#new_audio").fadeIn('slow');
      }
      
    </script>
  </body>
</html>